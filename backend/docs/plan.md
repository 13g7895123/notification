# 排程器控制功能需求規劃

> 文件建立日期：2026-01-01  
> 狀態：規劃中

---

## 📋 專案背景

目前排程器管理頁面已具備監控功能（狀態查看、健康檢查、日誌查詢），但缺乏直接控制排程器的能力。為了提升系統管理的便利性，需要在系統介面上實現排程器的啟動、停止、重啟功能。

---

## 🎯 功能目標

| 編號 | 功能 | 優先級 | 說明 |
|------|------|--------|------|
| F-001 | 停止排程器 | 🔴 高 | 管理員可透過介面停止排程器 |
| F-002 | 啟動排程器 | 🔴 高 | 管理員可透過介面啟動排程器 |
| F-003 | 重啟排程器 | 🟡 中 | 管理員可透過介面重啟排程器 |
| F-004 | 前端控制面板 | 🔴 高 | 在排程器管理頁面添加控制按鈕 |
| F-005 | 操作確認對話框 | 🟡 中 | 執行控制操作前需確認 |
| F-006 | 操作日誌記錄 | 🟢 低 | 記錄誰在何時執行了什麼操作 |

---

## 🏗️ 技術架構

### 後端 API 設計

#### 1. 停止排程器
```
POST /api/scheduler/stop
```

**Request Body:** 無

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "排程器已停止",
    "pid": 12345,
    "stoppedAt": "2026-01-01T12:00:00Z"
  }
}
```

**實現邏輯：**
1. 讀取 PID 檔案 (`writable/pids/scheduler.pid`)
2. 發送 SIGTERM 信號給進程
3. 等待進程結束（最多 10 秒）
4. 若未結束，發送 SIGKILL 強制終止
5. 清理 PID 檔案

---

#### 2. 啟動排程器
```
POST /api/scheduler/start
```

**Request Body:** 無

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "排程器已啟動",
    "pid": 12346,
    "startedAt": "2026-01-01T12:00:05Z"
  }
}
```

**實現邏輯：**
1. 檢查是否已有排程器在運行
2. 若已運行，返回 `already_running` 狀態
3. 執行 `php spark scheduler:daemon` 命令
4. 等待 PID 檔案生成（最多 5 秒）
5. 驗證進程已啟動

---

#### 3. 重啟排程器
```
POST /api/scheduler/restart
```

**Request Body:** 無

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "排程器已重啟",
    "oldPid": 12345,
    "newPid": 12346,
    "restartedAt": "2026-01-01T12:00:10Z"
  }
}
```

**實現邏輯：**
1. 調用停止邏輯
2. 等待 2 秒
3. 調用啟動邏輯

---

### 前端介面設計

#### 控制面板組件

```
┌─────────────────────────────────────────────────────────────┐
│  排程器管理                                    [重新整理]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 排程器狀態  │  │  上次執行   │  │  下次執行   │         │
│  │  🟢 運行中  │  │  12:07:36   │  │  12:08:36   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    排程器控制                        │   │
│  │                                                      │   │
│  │   [🟢 啟動]    [🔴 停止]    [🔄 重啟]              │   │
│  │                                                      │   │
│  │   ⚠️ 停止排程器將暫停所有排程訊息的發送            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  系統詳細檢測                        │   │
│  │  ✅ Scheduler Heartbeat - Last heartbeat 5s ago     │   │
│  │  ✅ Database Connection - Connected                  │   │
│  │  ✅ Daemon Process - Running (PID: 12345)           │   │
│  │  ✅ Scheduled Messages - 3 scheduled messages       │   │
│  │  ✅ Log File - Log file size: 0.5 MB                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 確認對話框

**停止確認：**
```
┌─────────────────────────────────────────┐
│  ⚠️ 確定要停止排程器嗎？               │
├─────────────────────────────────────────┤
│                                         │
│  停止後，所有排程訊息將暫停發送，      │
│  直到重新啟動排程器。                   │
│                                         │
│  目前有 3 筆排程訊息待處理。           │
│                                         │
│          [取消]     [確定停止]          │
└─────────────────────────────────────────┘
```

---

## 📁 需要修改的檔案

### 後端
| 檔案路徑 | 修改類型 | 說明 |
|----------|----------|------|
| `backend/app/Controllers/SchedulerController.php` | 修改 | 新增 stop、start、restart 方法 |
| `backend/app/Config/Routes.php` | 修改 | 新增路由 |
| `backend/docs/API.md` | 修改 | 更新 API 文件 |

### 前端
| 檔案路徑 | 修改類型 | 說明 |
|----------|----------|------|
| `frontend/src/pages/SchedulerManagement.tsx` | 修改 | 新增控制面板 UI |
| `frontend/src/pages/SchedulerManagement.css` | 修改 | 新增控制面板樣式 |
| `frontend/src/contexts/NotificationContext.tsx` | 修改 | 新增控制 API 調用方法 |
| `frontend/src/types/index.ts` | 修改 | 新增相關類型定義 |
| `frontend/docs/API_REQUIREMENTS.md` | 修改 | 更新前端 API 需求文件 |

---

## 🔒 安全考量

1. **權限控制**
   - 所有控制 API 僅限管理員 (`role: admin`) 存取
   - 使用現有的 `adminOnly` 過濾器

2. **操作確認**
   - 停止/重啟操作需二次確認
   - 顯示當前待處理的排程訊息數量

3. **防止誤操作**
   - 按鈕狀態根據排程器狀態動態啟用/禁用
   - 執行中的操作禁止重複觸發

4. **日誌記錄**
   - 記錄操作者、操作時間、操作類型
   - 寫入系統日誌供稽核

---

## 📅 開發排程

### Phase 1：後端 API（預估 1 小時）
- [ ] 實現 `SchedulerController::stop()`
- [ ] 實現 `SchedulerController::start()`
- [ ] 實現 `SchedulerController::restart()`
- [ ] 新增路由配置
- [ ] 單元測試

### Phase 2：前端整合（預估 1.5 小時）
- [ ] 新增控制 API 調用方法
- [ ] 實現控制面板 UI 組件
- [ ] 實現確認對話框
- [ ] 樣式調整
- [ ] 錯誤處理

### Phase 3：測試與文件（預估 0.5 小時）
- [ ] 整合測試
- [ ] 更新 API 文件
- [ ] 更新使用說明

---

## ✅ 驗收標準

1. **功能驗收**
   - [ ] 可透過介面成功啟動已停止的排程器
   - [ ] 可透過介面成功停止運行中的排程器
   - [ ] 可透過介面成功重啟排程器
   - [ ] 操作後狀態正確更新

2. **UI 驗收**
   - [ ] 按鈕狀態正確反映排程器狀態
   - [ ] 確認對話框正確顯示
   - [ ] 操作中顯示 loading 狀態
   - [ ] 操作結果顯示 toast 提示

3. **安全驗收**
   - [ ] 非管理員無法存取控制 API
   - [ ] 操作日誌正確記錄

---

## 🚀 後續擴展（未來考慮）

1. **排程任務管理**
   - 查看/取消特定排程訊息
   - 手動觸發排程訊息發送

2. **效能監控**
   - 排程器 CPU/記憶體使用量
   - 訊息處理速度統計

3. **告警機制**
   - 排程器停止超過 N 分鐘自動告警
   - 排程訊息積壓告警

---

## 📝 備註

- 此功能僅影響應用層排程器，不影響 Supervisor 的管理
- 在 Docker 環境中，若透過 Supervisor 管理排程器，需考慮與 Supervisor 的協同
- 建議在生產環境部署前進行完整測試
