# ===========================================
# NotifyHub - é–‹ç™¼ç’°å¢ƒè‡ªå‹•éƒ¨ç½²
# é€é SSH é€£ç·šåˆ°ä¼ºæœå™¨åŸ·è¡Œ git pull + shell script
# ===========================================

name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:  # æ”¯æ´æ‰‹å‹•è§¸ç™¼

env:
  DEPLOY_PATH: ${{ secrets.DEV_DEPLOY_PATH }}

jobs:
  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    
    steps:
      - name: é¡¯ç¤ºéƒ¨ç½²è³‡è¨Š
        run: |
          echo "ğŸš€ é–‹å§‹éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "è§¸ç™¼è€…: ${{ github.actor }}"

      - name: SSH é€£ç·šä¸¦éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT || 22 }}
          script: |
            echo "=========================================="
            echo "  NotifyHub é–‹ç™¼ç’°å¢ƒéƒ¨ç½²"
            echo "=========================================="
            
            # åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„
            cd ${{ secrets.DEV_DEPLOY_PATH }}
            
            # é¡¯ç¤ºç•¶å‰ç‹€æ…‹
            echo ""
            echo "[1/6] ç•¶å‰ Git ç‹€æ…‹:"
            echo "  åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
            echo "  Commit: $(git rev-parse --short HEAD)"
            
            # æ‹‰å–æœ€æ–°ä»£ç¢¼
            echo ""
            echo "[2/6] æ‹‰å–æœ€æ–°ä»£ç¢¼..."
            git fetch origin
            git pull origin develop
            
            echo ""
            echo "[3/6] æ›´æ–°å¾Œ Git ç‹€æ…‹:"
            echo "  Commit: $(git rev-parse --short HEAD)"
            
            # å»ºç«‹/æ›´æ–° .env æª”æ¡ˆ
            echo ""
            echo "[4/6] è¨­å®šç’°å¢ƒè®Šæ•¸..."
            
            # è¤‡è£½ .env.example ä½œç‚º .envï¼ˆå¦‚æœ .env ä¸å­˜åœ¨ï¼‰
            if [ ! -f .env ]; then
              cp .env.example .env
              echo "  å·²å¾ .env.example å»ºç«‹ .env"
              
              # è‡ªå‹•ç”Ÿæˆ JWT_SECRET
              NEW_JWT_SECRET=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c 48)
              sed -i "s|^JWT_SECRET=.*|JWT_SECRET=${NEW_JWT_SECRET}|" .env
              echo "  JWT_SECRET å·²è‡ªå‹•ç”Ÿæˆ"
            fi
            
            echo "  .env è¨­å®šå®Œæˆ"
            
            # åŸ·è¡Œéƒ¨ç½²è…³æœ¬
            echo ""
            echo "[5/6] åŸ·è¡Œéƒ¨ç½²..."
            ./deploy.sh build blue
            ./deploy.sh switch blue
            
            # é¡¯ç¤ºæœå‹™ç‹€æ…‹
            echo ""
            echo "[6/6] æœå‹™ç‹€æ…‹:"
            docker compose ps
            
            echo ""
            echo "=========================================="
            echo "  âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… é–‹ç™¼ç’°å¢ƒéƒ¨ç½²æˆåŠŸ"
          echo "Commit: ${{ github.sha }}"

      - name: éƒ¨ç½²å¤±æ•—é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ é–‹ç™¼ç’°å¢ƒéƒ¨ç½²å¤±æ•—"
          echo "è«‹æª¢æŸ¥æ—¥èªŒ"
