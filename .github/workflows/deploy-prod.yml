# ===========================================
# NotifyHub - ç”Ÿç”¢ç’°å¢ƒè‡ªå‹•éƒ¨ç½²
# é€é SSH é€£ç·šåˆ°ä¼ºæœå™¨åŸ·è¡Œ git pull + shell script
# ===========================================

name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # æ”¯æ´æ‰‹å‹•è§¸ç™¼

env:
  DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production  # éœ€è¦æ‰‹å‹•æ ¸å‡†ï¼ˆå¯é¸ï¼‰
    
    steps:
      - name: é¡¯ç¤ºéƒ¨ç½²è³‡è¨Š
        run: |
          echo "ğŸš€ é–‹å§‹éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "è§¸ç™¼è€…: ${{ github.actor }}"

      - name: SSH é€£ç·šä¸¦éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            echo "=========================================="
            echo "  NotifyHub ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²"
            echo "=========================================="
            
            # åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„
            cd ${{ secrets.PROD_DEPLOY_PATH }}
            
            # å‚™ä»½ç•¶å‰ç‰ˆæœ¬è³‡è¨Š
            BEFORE_COMMIT=$(git rev-parse --short HEAD)
            echo "$BEFORE_COMMIT" > /tmp/notifyhub_last_commit.txt
            
            # é¡¯ç¤ºç•¶å‰ç‹€æ…‹
            echo ""
            echo "[1/6] ç•¶å‰ Git ç‹€æ…‹:"
            echo "  åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
            echo "  Commit: $BEFORE_COMMIT"
            
            # æ‹‰å–æœ€æ–°ä»£ç¢¼
            echo ""
            echo "[2/7] æ‹‰å–æœ€æ–°ä»£ç¢¼..."
            git fetch origin
            git pull origin main || git pull origin master
            
            AFTER_COMMIT=$(git rev-parse --short HEAD)
            echo ""
            echo "[3/7] æ›´æ–°å¾Œ Git ç‹€æ…‹:"
            echo "  Commit: $AFTER_COMMIT"
            
            # å»ºç«‹/æ›´æ–° .env æª”æ¡ˆ
            echo ""
            echo "[4/7] è¨­å®šç’°å¢ƒè®Šæ•¸..."
            
            # è¤‡è£½ .env.example ä½œç‚º .envï¼ˆå¦‚æœ .env ä¸å­˜åœ¨ï¼‰
            if [ ! -f .env ]; then
              cp .env.example .env
              echo "  å·²å¾ .env.example å»ºç«‹ .env"
              
              # è‡ªå‹•ç”Ÿæˆ JWT_SECRET
              NEW_JWT_SECRET=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c 48)
              sed -i "s|^JWT_SECRET=.*|JWT_SECRET=${NEW_JWT_SECRET}|" .env
              echo "  JWT_SECRET å·²è‡ªå‹•ç”Ÿæˆ"
            fi
            
            echo "  .env è¨­å®šå®Œæˆ"
            
            # é¡¯ç¤ºè®Šæ›´
            echo ""
            echo "[5/7] è®Šæ›´æ‘˜è¦:"
            git log --oneline $BEFORE_COMMIT..$AFTER_COMMIT | head -10
            
            # åŸ·è¡Œéƒ¨ç½²è…³æœ¬ï¼ˆè—ç¶ éƒ¨ç½²ï¼‰
            echo ""
            echo "[6/7] åŸ·è¡Œè—ç¶ éƒ¨ç½²..."
            
            # å–å¾—ç•¶å‰æ´»èºç‰ˆæœ¬
            PROXY_CONF="./docker/frontend-proxy/conf.d/default.conf"
            if grep -q "server frontend-green:80;" "$PROXY_CONF" 2>/dev/null; then
              IDLE_VERSION="blue"
            else
              IDLE_VERSION="green"
            fi
            
            echo "æ­£åœ¨éƒ¨ç½²åˆ° $IDLE_VERSION ç‰ˆæœ¬..."
            ./scripts/deploy.sh build "$IDLE_VERSION"
            
            # å¥åº·æª¢æŸ¥
            echo "åŸ·è¡Œå¥åº·æª¢æŸ¥..."
            sleep 15
            
            # åˆ‡æ›æµé‡
            ./scripts/deploy.sh switch "$IDLE_VERSION"
            
            # é¡¯ç¤ºæœå‹™ç‹€æ…‹
            echo ""
            echo "[7/7] æœå‹™ç‹€æ…‹:"
            docker compose ps
            
            echo ""
            echo "=========================================="
            echo "  âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆï¼"
            echo "  ç‰ˆæœ¬: $BEFORE_COMMIT -> $AFTER_COMMIT"
            echo "=========================================="

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æˆåŠŸ"
          echo "Commit: ${{ github.sha }}"

      - name: éƒ¨ç½²å¤±æ•—é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¤±æ•—"
          echo "è«‹æª¢æŸ¥æ—¥èªŒä¸¦è€ƒæ…®å›æ»¾"
